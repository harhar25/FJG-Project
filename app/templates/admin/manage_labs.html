{% extends "base.html" %}

{% block title %}Manage Labs - IT Lab Schedule System{% endblock %}

{% block styles %}
{{ super() }}
<style>
/* Ensure modal backdrops work correctly */
.modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1040;
    width: 100vw;
    height: 100vh;
    background-color: #000;
}

.modal-backdrop.fade {
    opacity: 0;
}

.modal-backdrop.show {
    opacity: 0.5;
}

/* Ensure modals are properly positioned */
.modal {
    display: none;
    overflow: hidden;
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    z-index: 1050;
    outline: 0;
}

.modal-dialog {
    position: relative;
    width: auto;
    margin: 0.5rem;
    pointer-events: none;
}

.modal.fade .modal-dialog {
    transition: transform 0.3s ease-out;
    transform: translate(0, -50px);
}

@media (prefers-reduced-motion: reduce) {
    .modal.fade .modal-dialog {
        transition: none;
    }
}

.modal.show .modal-dialog {
    transform: none;
}

.modal-dialog-centered {
    display: flex;
    align-items: center;
    min-height: calc(100% - 1rem);
}

.modal-content {
    position: relative;
    display: flex;
    flex-direction: column;
    width: 100%;
    pointer-events: auto;
    background-color: #fff;
    background-clip: padding-box;
    border: 1px solid rgba(0, 0, 0, 0.2);
    border-radius: 0.3rem;
    outline: 0;
}

/* Toast positioning */
.toast-container {
    z-index: 1090;
}

/* Debug button styling */
#debugBtn {
    z-index: 9999;
}
</style>
{% endblock %}

{% block content %}
<!-- Content Header -->
<div class="content-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1><i class="fas fa-flask-vial me-2"></i>Manage Laboratory Rooms</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
                    <li class="breadcrumb-item active">Laboratories</li>
                </ol>
            </nav>
        </div>
        <button class="btn btn-modern btn-modern-primary" data-bs-toggle="modal" data-bs-target="#addLabModal">
            <i class="fas fa-plus me-2"></i>Add New Lab
        </button>
    </div>
</div>

<!-- Stats Overview -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-flask"></i>
        </div>
        <div class="stat-number" id="totalLabs">0</div>
        <div class="stat-label">Total Labs</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-users"></i>
        </div>
        <div class="stat-number" id="avgCapacity">0</div>
        <div class="stat-label">Avg Capacity</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-map-pin"></i>
        </div>
        <div class="stat-number" id="totalLocations">0</div>
        <div class="stat-label">Locations</div>
    </div>
</div>

<!-- Search and Actions -->
<div class="premium-card">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-6">
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" class="form-control" placeholder="Search labs..." id="labSearch">
                </div>
            </div>
            <div class="col-md-6 text-end">
                <div class="btn-group d-none d-md-flex">
                    <button class="btn btn-outline-secondary" onclick="sortLabs('name')">
                        <i class="fas fa-sort-alpha-down me-2"></i>Sort by Name
                    </button>
                    <button class="btn btn-outline-secondary" onclick="sortLabs('capacity')">
                        <i class="fas fa-users me-2"></i>Sort by Capacity
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Labs Table -->
<div class="premium-card">
    <div class="card-header">
        <h3><i class="fas fa-list"></i>Laboratories List</h3>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table premium-table" id="labsTable">
                <thead>
                    <tr>
                        <th>Lab Code</th>
                        <th>Lab Name</th>
                        <th>Capacity</th>
                        <th>Location</th>
                        <th>Equipment</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="labsTbody">
                    {% if labs.items %}
                        {% for lab in labs.items %}
                        <tr>
                            <td><span class="badge bg-primary">{{ lab.lab_code }}</span></td>
                            <td><strong>{{ lab.lab_name }}</strong></td>
                            <td>
                                <span class="badge bg-info">{{ lab.capacity }} students</span>
                            </td>
                            <td>
                                <i class="fas fa-map-pin text-primary me-1"></i>{{ lab.location }}
                            </td>
                            <td>
                                <small class="text-muted">
                                    {% if lab.equipment %}
                                        {{ lab.equipment[:40] }}{% if lab.equipment|length > 40 %}...{% endif %}
                                    {% else %}
                                        <em>Not specified</em>
                                    {% endif %}
                                </small>
                            </td>
                            <td class="text-center">
                                <a href="{{ url_for('admin.edit_lab', lab_id=lab.id) }}" class="btn btn-action btn-outline-primary" title="Edit">
                                    <i class="fas fa-edit"></i> 
                                </a>
                                <form method="POST" action="{{ url_for('admin.manage_labs') }}" style="display:inline;">
                                    <input type="hidden" name="action" value="delete">
                                    <input type="hidden" name="lab_id" value="{{ lab.id }}">
                                    <button type="submit" class="btn btn-action btn-outline-danger" onclick="return confirm('Are you sure?')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="fas fa-inbox"></i><br>
                            <strong>No laboratories found</strong>
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Pagination -->
{% if labs.pages > 1 %}
<nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center">
        {% if labs.has_prev %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('admin.manage_labs', page=labs.prev_num) }}">
                <i class="fas fa-chevron-left"></i>
            </a>
        </li>
        {% endif %}
        
        {% for page_num in labs.iter_pages() %}
            {% if page_num %}
                {% if page_num == labs.page %}
                <li class="page-item active">
                    <span class="page-link">{{ page_num }}</span>
                </li>
                {% else %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('admin.manage_labs', page=page_num) }}">{{ page_num }}</a>
                </li>
                {% endif %}
            {% endif %}
        {% endfor %}
        
        {% if labs.has_next %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('admin.manage_labs', page=labs.next_num) }}">
                <i class="fas fa-chevron-right"></i>
            </a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<script>
// Table functionality
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('labsTable');
    const tbody = document.getElementById('labsTbody');
    const searchInput = document.getElementById('labSearch');

    function updateStats() {
        const visibleRows = Array.from(tbody.querySelectorAll('tr'))
            .filter(r => !r.querySelector('td[colspan]') && r.style.display !== 'none');
        document.getElementById('totalLabs').textContent = visibleRows.length;

        let totalCapacity = 0;
        const locations = new Set();
        visibleRows.forEach(row => {
            const capacity = parseInt(row.cells[2].innerText) || 0;
            totalCapacity += capacity;
            const location = row.cells[3].innerText.trim();
            if (location) locations.add(location);
        });
        const avgCapacity = visibleRows.length > 0 ? Math.round(totalCapacity / visibleRows.length) : 0;
        document.getElementById('avgCapacity').textContent = avgCapacity;
        document.getElementById('totalLocations').textContent = locations.size;
    }

    // Live search
    if (searchInput && table) {
        const onSearch = () => {
            const filter = searchInput.value.toLowerCase();
            tbody.querySelectorAll('tr').forEach(row => {
                if (row.querySelector('td[colspan]')) return;
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(filter) ? '' : 'none';
            });
            updateStats();
        };
        searchInput.addEventListener('input', onSearch);
    }

    // Sorting
    window.sortLabs = function(by) {
        const rows = Array.from(tbody.querySelectorAll('tr'))
            .filter(r => !r.querySelector('td[colspan]'));

        let getKey;
        if (by === 'name') {
            getKey = (row) => row.cells[1].innerText.trim().toLowerCase();
        } else if (by === 'capacity') {
            getKey = (row) => parseInt(row.cells[2].innerText) || 0;
        } else {
            return;
        }

        const isNumeric = by === 'capacity';
        rows.sort((a, b) => {
            const ka = getKey(a);
            const kb = getKey(b);
            if (isNumeric) return ka - kb;
            return ka.localeCompare(kb);
        });

        rows.forEach(r => tbody.appendChild(r));
        updateStats();
    }

    // Initial stats
    updateStats();
});
</script>
{% endblock %}

{% block modals %}
<!-- Add Lab Modal -->
<div class="modal fade" id="addLabModal" tabindex="-1" aria-labelledby="addLabModalLabel" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="addLabForm" method="POST" action="{{ url_for('admin.manage_labs') }}">
                <div class="modal-header" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white;">
                    <h5 class="modal-title"><i class="fas fa-flask me-2"></i>Add New Laboratory</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="padding: 2rem;">
                    <input type="hidden" name="action" value="add">
                    
                    <div class="mb-4">
                        <label for="lab_name" class="form-label fw-bold">Lab Name</label>
                        <input type="text" class="form-control form-control-lg" id="lab_name" name="lab_name" 
                               placeholder="e.g., Computer Lab A" required autofocus>
                    </div>
                    
                    <div class="mb-4">
                        <label for="lab_code" class="form-label fw-bold">Lab Code</label>
                        <input type="text" class="form-control form-control-lg" id="lab_code" name="lab_code" 
                               placeholder="e.g., LAB001" required>
                        <div class="form-text">Enter a unique identifier for this lab</div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="capacity" class="form-label fw-bold">Capacity</label>
                        <input type="number" class="form-control form-control-lg" id="capacity" name="capacity" 
                               value="30" min="1" required>
                        <div class="form-text">Maximum number of students</div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="location" class="form-label fw-bold">Location</label>
                        <input type="text" class="form-control form-control-lg" id="location" name="location" 
                               placeholder="e.g., Building A, Floor 2" required>
                    </div>
                    
                    <div class="mb-4">
                        <label for="equipment" class="form-label fw-bold">Equipment</label>
                        <textarea class="form-control form-control-lg" id="equipment" name="equipment" 
                                 rows="3" placeholder="e.g., Computers, Projector, Whiteboard"></textarea>
                        <div class="form-text">Separate items with commas</div>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #e5e7eb; padding: 1.5rem;">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> Cancel
                    </button>
                    <button type="submit" class="btn-modern btn-modern-primary" id="submitLabForm">
                        <i class="fas fa-plus me-2"></i>Add Laboratory
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Toast for success/error messages -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1090">
    <div id="toastMessage" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
        <div class="toast-header bg-success text-white">
            <strong class="me-auto">Success</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            Operation completed successfully.
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// ==================== DEBUGGING & SAFE INITIALIZATION ====================
console.log('========== MANAGE LABS DEBUG ==========');
console.log('Bootstrap available:', typeof bootstrap !== 'undefined');
console.log('Bootstrap Modal class:', typeof bootstrap?.Modal !== 'undefined');
console.log('Bootstrap version:', bootstrap?.Modal?.VERSION || 'Unknown');

// Check for duplicate Bootstrap loads
const bootstrapScripts = document.querySelectorAll('script[src*="bootstrap"]');
console.log('Bootstrap scripts found:', bootstrapScripts.length);
bootstrapScripts.forEach((script, i) => {
    console.log(`  Script ${i}:`, script.src);
});

// Safe Bootstrap Component Initialization
function safeInitializeBootstrapComponents() {
    console.log('Safely initializing Bootstrap components...');
    
    // Check if Bootstrap is available
    if (typeof bootstrap === 'undefined') {
        console.error('Bootstrap is not loaded!');
        return;
    }
    
    // SAFE TOOLTIP INITIALIZATION (if needed)
    if (typeof bootstrap.Tooltip !== 'undefined') {
        const tooltipElements = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltipElements.forEach(element => {
            try {
                // Use getOrCreateInstance which is safer than new
                bootstrap.Tooltip.getOrCreateInstance(element);
            } catch (e) {
                console.warn('Could not initialize tooltip:', e);
            }
        });
    }
    
    // SAFE TOAST INITIALIZATION (if needed)
    if (typeof bootstrap.Toast !== 'undefined') {
        const toastElements = document.querySelectorAll('.toast');
        toastElements.forEach(element => {
            try {
                // Use getOrCreateInstance which is safer than new
                bootstrap.Toast.getOrCreateInstance(element);
            } catch (e) {
                console.warn('Could not initialize toast:', e);
            }
        });
    }
    
    // IMPORTANT: DO NOT INITIALIZE MODALS - Bootstrap auto-initializes them via data attributes
    console.log('Modals are auto-initialized by Bootstrap via data-bs-toggle attributes');
    
    // Verify modals exist
    const modals = document.querySelectorAll('.modal');
    console.log('Modal elements found:', modals.length);
    
    // Check modal triggers
    const modalTriggers = document.querySelectorAll('[data-bs-toggle="modal"]');
    console.log('Modal triggers found:', modalTriggers.length);
}

// ==================== FORM HANDLING ====================
function setupFormHandlers() {
    console.log('Setting up form handlers...');
    
    // Handle add lab form submission
    const addLabForm = document.getElementById('addLabForm');
    
    if (addLabForm) {
        console.log('Add Lab Form found');
        
        addLabForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('Add Lab Form submitted');
            
            const submitButton = this.querySelector('button[type="submit"]');
            const originalButtonText = submitButton?.innerHTML;
            
            try {
                // Show loading state
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
                }
                
                const formData = new FormData(this);
                const response = await fetch(this.getAttribute('action'), {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    }
                });
                
                const data = await response.json();
                console.log('Server response:', data);
                
                if (data.success) {
                    // Show success message
                    showToast(data.message || 'Operation completed successfully!', 'success');
                    
                    // Close modal safely
                    const modalElement = document.getElementById('addLabModal');
                    if (modalElement) {
                        // Try to get existing modal instance
                        if (typeof bootstrap !== 'undefined' && typeof bootstrap.Modal !== 'undefined') {
                            const modalInstance = bootstrap.Modal.getInstance(modalElement);
                            if (modalInstance) {
                                modalInstance.hide();
                            } else {
                                // Fallback: click close button
                                const closeBtn = modalElement.querySelector('[data-bs-dismiss="modal"]');
                                if (closeBtn) closeBtn.click();
                            }
                        } else {
                            // Fallback: click close button
                            const closeBtn = modalElement.querySelector('[data-bs-dismiss="modal"]');
                            if (closeBtn) closeBtn.click();
                        }
                    }
                    
                    // Reload the page after a short delay
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    throw new Error(data.message || 'An error occurred');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast(error.message || 'An error occurred. Please try again.', 'error');
            } finally {
                // Reset button state
                if (submitButton) {
                    submitButton.disabled = false;
                    if (originalButtonText) {
                        submitButton.innerHTML = originalButtonText;
                    }
                }
            }
        });
    } else {
        console.log('Add Lab Form not found');
    }
}

// Helper function to show toast messages
function showToast(message, type = 'info') {
    console.log('Showing toast:', type, message);
    const toastEl = document.getElementById('toastMessage');
    if (!toastEl) {
        console.log('Toast element not found');
        return;
    }
    
    // Update toast content
    const toastBody = toastEl.querySelector('.toast-body');
    const toastHeader = toastEl.querySelector('.toast-header');
    
    if (toastBody) {
        toastBody.textContent = message;
    }
    
    if (toastHeader) {
        // Update toast header based on type
        const typeClasses = {
            'success': 'bg-success text-white',
            'error': 'bg-danger text-white',
            'warning': 'bg-warning text-dark',
            'info': 'bg-info text-white'
        };
        
        toastHeader.className = `toast-header ${typeClasses[type] || 'bg-primary text-white'}`;
        const strong = toastHeader.querySelector('strong');
        if (strong) {
            strong.textContent = type.charAt(0).toUpperCase() + type.slice(1);
        }
    }
    
    // Show toast using Bootstrap if available
    if (typeof bootstrap !== 'undefined' && typeof bootstrap.Toast !== 'undefined') {
        try {
            const toast = bootstrap.Toast.getOrCreateInstance(toastEl);
            toast.show();
        } catch (e) {
            console.warn('Could not show toast via Bootstrap:', e);
            // Fallback: show manually
            toastEl.classList.add('show');
            setTimeout(() => toastEl.classList.remove('show'), 5000);
        }
    } else {
        // Fallback: show manually
        toastEl.classList.add('show');
        setTimeout(() => toastEl.classList.remove('show'), 5000);
    }
}

// ==================== MAIN INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM fully loaded, initializing...');
    
    // Initialize Bootstrap components safely
    safeInitializeBootstrapComponents();
    
    // Setup form handlers
    setupFormHandlers();
    
    // Add debug button
    const debugBtn = document.createElement('button');
    debugBtn.id = 'debugBtn';
    debugBtn.className = 'btn btn-warning btn-sm position-fixed bottom-0 end-0 m-3';
    debugBtn.textContent = 'Debug';
    debugBtn.style.zIndex = '9999';
    debugBtn.onclick = function() {
        console.log('=== DEBUG INFO ===');
        console.log('Bootstrap:', typeof bootstrap !== 'undefined' ? 'Loaded' : 'NOT LOADED');
        console.log('Modal triggers:', document.querySelectorAll('[data-bs-toggle="modal"]').length);
        console.log('Modals:', document.querySelectorAll('.modal').length);
        console.log('Active modal:', document.querySelector('.modal.show'));
        
        // Test modal functionality
        const testTrigger = document.querySelector('[data-bs-toggle="modal"]');
        if (testTrigger) {
            console.log('First modal trigger:', testTrigger.getAttribute('data-bs-target'));
        }
    };
    document.body.appendChild(debugBtn);
    
    // Additional debugging for modal clicks
    document.addEventListener('click', function(e) {
        if (e.target.hasAttribute('data-bs-toggle') && 
            e.target.getAttribute('data-bs-toggle') === 'modal') {
            console.log('Modal trigger clicked:', e.target.getAttribute('data-bs-target'));
            console.log('Bootstrap available for modal:', typeof bootstrap?.Modal !== 'undefined');
        }
    }, true);
});

// Test function to verify Bootstrap works
window.testModal = function() {
    console.log('Testing modal functionality...');
    
    if (typeof bootstrap === 'undefined') {
        alert('ERROR: Bootstrap is not loaded!');
        return;
    }
    
    if (typeof bootstrap.Modal === 'undefined') {
        alert('ERROR: Bootstrap Modal class is not available!');
        return;
    }
    
    // Test with existing modal
    const modalElement = document.getElementById('addLabModal');
    if (modalElement) {
        try {
            // Use getOrCreateInstance which is safer
            const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
            modal.show();
            console.log('Modal shown successfully!');
            
            setTimeout(() => {
                modal.hide();
                console.log('Modal hidden successfully!');
            }, 2000);
        } catch (error) {
            console.error('Error testing modal:', error);
            alert('Error testing modal: ' + error.message);
        }
    } else {
        alert('No modal found to test');
    }
};
</script>
{% endblock %}
