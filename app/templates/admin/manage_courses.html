{% extends "base.html" %}

{% block title %}Manage Courses - IT Lab Schedule System{% endblock %}

{% block styles %}
{{ super() }}
<style>
/* Scrollable Table Container */
.table-scroll-container {
    max-height: 600px;
    overflow-y: auto;
    border-radius: 0.5rem;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
}

.table-scroll-container::-webkit-scrollbar {
    width: 8px;
}

.table-scroll-container::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 10px;
}

.table-scroll-container::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    border-radius: 10px;
}

.table-scroll-container::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
}

/* Sticky table header */
.table-scroll-container .table thead {
    position: sticky;
    top: 0;
    z-index: 10;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
}

.table-scroll-container .table thead th {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
    font-weight: 600;
    border: none;
    padding: 1rem;
    text-transform: uppercase;
    font-size: 0.85rem;
    letter-spacing: 0.5px;
}

/* Enhanced Add Course Button */
.btn-add-course {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    border: none;
    color: white;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    border-radius: 0.5rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
}

.btn-add-course:hover {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
    color: white;
    text-decoration: none;
}

.btn-add-course:active {
    transform: translateY(0);
    box-shadow: 0 2px 10px rgba(99, 102, 241, 0.3);
}

.btn-add-course i {
    font-size: 1.1rem;
}

/* Table row hover effect */
.table-scroll-container .table tbody tr {
    transition: all 0.2s ease;
    border-bottom: 1px solid #e5e7eb;
}

.table-scroll-container .table tbody tr:hover {
    background-color: #f8f9ff;
    box-shadow: inset 0 0 10px rgba(99, 102, 241, 0.1);
}

/* New row animation */
.table-scroll-container .table tbody tr.new-row {
    animation: slideIn 0.5s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Course code badge */
.course-code-badge {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
    padding: 0.4rem 0.8rem;
    border-radius: 0.4rem;
    font-weight: 600;
    font-size: 0.85rem;
    display: inline-block;
}

/* Delete button styling */
.btn-delete-course {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    border: none;
    color: white;
    padding: 0.4rem 0.8rem;
    border-radius: 0.4rem;
    font-size: 0.85rem;
    font-weight: 600;
    transition: all 0.2s ease;
    cursor: pointer;
}

.btn-delete-course:hover {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    transform: scale(1.05);
}

/* Empty state styling */
.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: #6b7280;
}

.empty-state i {
    font-size: 3rem;
    color: #d1d5db;
    margin-bottom: 1rem;
}
</style>
{% endblock %}

{% block content %}
<!-- Content Header -->
<div class="content-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1><i class="fas fa-book me-2"></i>Manage Courses</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item active">Courses</li>
                </ol>
            </nav>
        </div>
        <button class="btn-add-course" data-bs-toggle="modal" data-bs-target="#addCourseModal">
            <i class="fas fa-plus"></i>Add New Course
        </button>
    </div>
</div>

<!-- Courses Table -->
<div class="premium-card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h3><i class="fas fa-list"></i>Courses List</h3>
            <span class="badge bg-primary" id="courseCount">{{ courses.total }}</span>
        </div>
    </div>
    <div class="card-body p-0">
        {% if courses.items %}
        <div class="table-scroll-container">
            <table class="table premium-table mb-0" id="coursesTable">
                <thead>
                    <tr>
                        <th style="width: 20%;">Course Code</th>
                        <th style="width: 50%;">Course Name</th>
                        <th style="width: 30%; text-align: center;">Actions</th>
                    </tr>
                </thead>
                <tbody id="coursesTableBody">
                    {% for course in courses.items %}
                    <tr data-course-id="{{ course.id }}">
                        <td>
                            <span class="course-code-badge">{{ course.course_code }}</span>
                        </td>
                        <td>
                            <strong>{{ course.course_name }}</strong>
                        </td>
                        <td style="text-align: center;">
                            <button class="btn-delete-course" data-course-id="{{ course.id }}" data-course-name="{{ course.course_name }}">
                                <i class="fas fa-trash me-1"></i>Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <p><strong>No courses found</strong></p>
            <p class="text-muted">Click "Add New Course" to create your first course</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- Add Course Modal -->
<div class="modal fade" id="addCourseModal" tabindex="-1" aria-labelledby="addCourseModalLabel" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="addCourseForm" method="POST" action="{{ url_for('admin.manage_courses') }}">
                <div class="modal-header" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white;">
                    <h5 class="modal-title"><i class="fas fa-book me-2"></i>Add New Course</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="padding: 2rem;">
                    <input type="hidden" name="action" value="add">
                    <div class="mb-4">
                        <label for="course_code" class="form-label fw-bold">Course Code</label>
                        <input type="text" class="form-control form-control-lg" id="course_code" name="course_code" required 
                               placeholder="e.g., CS101" autofocus>
                        <div class="form-text">Enter a unique course code (e.g., CS101, MATH201)</div>
                    </div>
                    <div class="mb-4">
                        <label for="course_name" class="form-label fw-bold">Course Name</label>
                        <input type="text" class="form-control form-control-lg" id="course_name" name="course_name" required
                               placeholder="e.g., Introduction to Computer Science">
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #e5e7eb; padding: 1.5rem;">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> Cancel
                    </button>
                    <button type="submit" class="btn-modern btn-modern-primary">
                        <i class="fas fa-plus me-2"></i>Add Course
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Toast for success/error messages -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1090">
    <div id="toastMessage" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
        <div class="toast-header bg-success text-white">
            <strong class="me-auto">Success</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            Operation completed successfully.
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
console.log('========== MANAGE COURSES DEBUG ==========');

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM fully loaded, initializing...');
    
    // ==================== ADD COURSE HANDLER ====================
    const addCourseForm = document.getElementById('addCourseForm');
    
    if (addCourseForm) {
        console.log('Add Course Form found');
        
        addCourseForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('Add Course Form submitted');
            
            const submitButton = this.querySelector('button[type="submit"]');
            const originalButtonText = submitButton?.innerHTML;
            const courseCodeInput = document.getElementById('course_code');
            const courseNameInput = document.getElementById('course_name');
            
            try {
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
                }
                
                const formData = new FormData(this);
                const response = await fetch(this.getAttribute('action'), {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    }
                });
                
                const data = await response.json();
                console.log('Server response:', data);
                
                if (data.success) {
                    showToast(data.message || 'Course added successfully!', 'success');
                    
                    // Add new course to table
                    const courseCode = courseCodeInput.value;
                    const courseName = courseNameInput.value;
                    addCourseToTable(courseCode, courseName);
                    
                    // Update course count
                    const courseCount = document.getElementById('courseCount');
                    if (courseCount) {
                        courseCount.textContent = parseInt(courseCount.textContent) + 1;
                    }
                    
                    // Reset form
                    this.reset();
                    
                    // Close modal and remove focus
                    const modalElement = document.getElementById('addCourseModal');
                    if (modalElement && typeof bootstrap !== 'undefined') {
                        const modalInstance = bootstrap.Modal.getInstance(modalElement);
                        if (modalInstance) {
                            modalInstance.hide();
                        }
                    }
                    
                    // Remove aria-hidden after modal closes
                    setTimeout(() => {
                        if (modalElement) {
                            modalElement.setAttribute('aria-hidden', 'true');
                        }
                        courseCodeInput.blur();
                    }, 300);
                } else {
                    throw new Error(data.message || 'An error occurred');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast(error.message || 'An error occurred. Please try again.', 'error');
            } finally {
                if (submitButton) {
                    submitButton.disabled = false;
                    if (originalButtonText) {
                        submitButton.innerHTML = originalButtonText;
                    }
                }
            }
        });
    }
    
    // ==================== DELETE COURSE HANDLER ====================
    setupDeleteHandlers();
});

function addCourseToTable(courseCode, courseName) {
    console.log('Adding course to table:', courseCode, courseName);
    
    let tbody = document.getElementById('coursesTableBody');
    let scrollContainer = document.querySelector('.table-scroll-container');
    
    // If table doesn't exist, create it
    if (!tbody) {
        console.log('Table body not found, creating table structure...');
        
        const cardBody = document.querySelector('.premium-card .card-body');
        if (!cardBody) {
            console.error('Card body not found');
            return;
        }
        
        // Remove empty state if it exists
        const emptyState = cardBody.querySelector('.empty-state');
        if (emptyState) {
            emptyState.remove();
        }
        
        // Create table structure
        const tableHTML = `
            <div class="table-scroll-container">
                <table class="table premium-table mb-0" id="coursesTable">
                    <thead>
                        <tr>
                            <th style="width: 20%;">Course Code</th>
                            <th style="width: 50%;">Course Name</th>
                            <th style="width: 30%; text-align: center;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="coursesTableBody">
                    </tbody>
                </table>
            </div>
        `;
        
        cardBody.innerHTML = tableHTML;
        tbody = document.getElementById('coursesTableBody');
        scrollContainer = document.querySelector('.table-scroll-container');
    }
    
    // Remove empty state if it exists
    const emptyState = document.querySelector('.empty-state');
    if (emptyState) {
        emptyState.remove();
    }
    
    // Create new row
    const newRow = document.createElement('tr');
    newRow.className = 'new-row';
    newRow.innerHTML = `
        <td>
            <span class="course-code-badge">${escapeHtml(courseCode)}</span>
        </td>
        <td>
            <strong>${escapeHtml(courseName)}</strong>
        </td>
        <td style="text-align: center;">
            <button class="btn-delete-course" data-course-name="${escapeHtml(courseName)}">
                <i class="fas fa-trash me-1"></i>Delete
            </button>
        </td>
    `;
    
    // Add to top of table
    if (tbody) {
        tbody.insertBefore(newRow, tbody.firstChild);
        console.log('Course row added to table');
    }
    
    // Setup delete handler for new row
    const deleteBtn = newRow.querySelector('.btn-delete-course');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', handleDeleteClick);
    }
    
    // Scroll to top to show new course
    if (scrollContainer) {
        scrollContainer.scrollTop = 0;
    }
}

function setupDeleteHandlers() {
    document.querySelectorAll('.btn-delete-course').forEach(btn => {
        btn.addEventListener('click', handleDeleteClick);
    });
}

function handleDeleteClick(e) {
    e.preventDefault();
    const btn = e.currentTarget;
    const courseName = btn.getAttribute('data-course-name');
    const row = btn.closest('tr');
    
    // Show confirmation dialog
    if (confirm(`Are you sure you want to delete the course "${courseName}"?`)) {
        deleteCourse(row, btn);
    }
}

async function deleteCourse(row, btn) {
    try {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        
        const formData = new FormData();
        formData.append('action', 'delete');
        formData.append('course_id', row.getAttribute('data-course-id'));
        
        const response = await fetch('{{ url_for("admin.manage_courses") }}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast(data.message || 'Course deleted successfully!', 'success');
            
            // Remove row with animation
            row.style.animation = 'slideIn 0.3s ease-out reverse';
            setTimeout(() => {
                row.remove();
                
                // Update course count
                const courseCount = document.getElementById('courseCount');
                if (courseCount) {
                    courseCount.textContent = Math.max(0, parseInt(courseCount.textContent) - 1);
                }
                
                // Check if table is empty
                const tbody = document.getElementById('coursesTableBody');
                if (tbody && tbody.children.length === 0) {
                    location.reload();
                }
            }, 300);
        } else {
            throw new Error(data.message || 'Failed to delete course');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast(error.message || 'An error occurred. Please try again.', 'error');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-trash me-1"></i>Delete';
    }
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

// Helper function to show toast messages
function showToast(message, type = 'info') {
    console.log('Showing toast:', type, message);
    const toastEl = document.getElementById('toastMessage');
    if (!toastEl) {
        console.log('Toast element not found');
        return;
    }
    
    const toastBody = toastEl.querySelector('.toast-body');
    const toastHeader = toastEl.querySelector('.toast-header');
    
    if (toastBody) {
        toastBody.textContent = message;
    }
    
    if (toastHeader) {
        const typeClasses = {
            'success': 'bg-success text-white',
            'error': 'bg-danger text-white',
            'warning': 'bg-warning text-dark',
            'info': 'bg-info text-white'
        };
        
        toastHeader.className = `toast-header ${typeClasses[type] || 'bg-primary text-white'}`;
        const strong = toastHeader.querySelector('strong');
        if (strong) {
            strong.textContent = type.charAt(0).toUpperCase() + type.slice(1);
        }
    }
    
    if (typeof bootstrap !== 'undefined' && typeof bootstrap.Toast !== 'undefined') {
        try {
            const toast = bootstrap.Toast.getOrCreateInstance(toastEl);
            toast.show();
        } catch (e) {
            console.warn('Could not show toast via Bootstrap:', e);
            toastEl.classList.add('show');
            setTimeout(() => toastEl.classList.remove('show'), 5000);
        }
    } else {
        toastEl.classList.add('show');
        setTimeout(() => toastEl.classList.remove('show'), 5000);
    }
}
</script>
{% endblock %}
