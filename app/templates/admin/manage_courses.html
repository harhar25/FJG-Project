{% extends "base.html" %}

{% block title %}Manage Courses - IT Lab Schedule System{% endblock %}

{% block styles %}
{{ super() }}
<style>
/* Ensure modal backdrops work correctly */
.modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1040;
    width: 100vw;
    height: 100vh;
    background-color: #000;
}

.modal-backdrop.fade {
    opacity: 0;
}

.modal-backdrop.show {
    opacity: 0.5;
}

/* Ensure modals are properly positioned */
.modal {
    display: none;
    overflow: hidden;
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    z-index: 1050;
    outline: 0;
}

.modal-dialog {
    position: relative;
    width: auto;
    margin: 0.5rem;
    pointer-events: none;
}

.modal.fade .modal-dialog {
    transition: transform 0.3s ease-out;
    transform: translate(0, -50px);
}

@media (prefers-reduced-motion: reduce) {
    .modal.fade .modal-dialog {
        transition: none;
    }
}

.modal.show .modal-dialog {
    transform: none;
}

.modal-dialog-centered {
    display: flex;
    align-items: center;
    min-height: calc(100% - 1rem);
}

.modal-content {
    position: relative;
    display: flex;
    flex-direction: column;
    width: 100%;
    pointer-events: auto;
    background-color: #fff;
    background-clip: padding-box;
    border: 1px solid rgba(0, 0, 0, 0.2);
    border-radius: 0.3rem;
    outline: 0;
}

/* Toast positioning */
.toast-container {
    z-index: 1090;
}

/* Scrollable Table Container */
.table-scroll-container {
    max-height: 600px;
    overflow-y: auto;
    border-radius: 0.5rem;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
}

.table-scroll-container::-webkit-scrollbar {
    width: 8px;
}

.table-scroll-container::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 10px;
}

.table-scroll-container::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    border-radius: 10px;
}

.table-scroll-container::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
}

/* Sticky table header */
.table-scroll-container .table thead {
    position: sticky;
    top: 0;
    z-index: 10;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
}

.table-scroll-container .table thead th {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
    font-weight: 600;
    border: none;
    padding: 1rem;
    text-transform: uppercase;
    font-size: 0.85rem;
    letter-spacing: 0.5px;
}

/* Enhanced Add Course Button */
.btn-add-course {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    border: none;
    color: white;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    border-radius: 0.5rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
}

.btn-add-course:hover {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
    color: white;
    text-decoration: none;
}

.btn-add-course:active {
    transform: translateY(0);
    box-shadow: 0 2px 10px rgba(99, 102, 241, 0.3);
}

.btn-add-course i {
    font-size: 1.1rem;
}

/* Table row hover effect */
.table-scroll-container .table tbody tr {
    transition: all 0.2s ease;
    border-bottom: 1px solid #e5e7eb;
}

.table-scroll-container .table tbody tr:hover {
    background-color: #f8f9ff;
    box-shadow: inset 0 0 10px rgba(99, 102, 241, 0.1);
}

/* Course code badge */
.course-code-badge {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
    padding: 0.4rem 0.8rem;
    border-radius: 0.4rem;
    font-weight: 600;
    font-size: 0.85rem;
    display: inline-block;
}

/* Delete button styling */
.btn-delete-course {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    border: none;
    color: white;
    padding: 0.4rem 0.8rem;
    border-radius: 0.4rem;
    font-size: 0.85rem;
    font-weight: 600;
    transition: all 0.2s ease;
}

.btn-delete-course:hover {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    transform: scale(1.05);
}

/* Empty state styling */
.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: #6b7280;
}

.empty-state i {
    font-size: 3rem;
    color: #d1d5db;
    margin-bottom: 1rem;
}

/* Enhanced Pagination Styling */
.pagination {
    gap: 0.5rem;
}

.pagination .page-link {
    border: 2px solid #e5e7eb;
    color: #6366f1;
    font-weight: 600;
    border-radius: 0.5rem;
    transition: all 0.3s ease;
    padding: 0.5rem 0.75rem;
}

.pagination .page-link:hover {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
    border-color: #6366f1;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}

.pagination .page-item.active .page-link {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    border-color: #6366f1;
    color: white;
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}

.pagination .page-item.disabled .page-link {
    color: #d1d5db;
    border-color: #e5e7eb;
    cursor: not-allowed;
}

/* Page info styling */
.page-info {
    text-align: center;
    color: #6b7280;
    font-size: 0.9rem;
    margin-top: 1rem;
}
</style>
{% endblock %}

{% block content %}
<!-- Content Header -->
<div class="content-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1><i class="fas fa-book me-2"></i>Manage Courses</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item active">Courses</li>
                </ol>
            </nav>
        </div>
        <button class="btn-add-course" data-bs-toggle="modal" data-bs-target="#addCourseModal">
            <i class="fas fa-plus"></i>Add New Course
        </button>
    </div>
</div>

<!-- Courses Table -->
<div class="premium-card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h3><i class="fas fa-list"></i>Courses List</h3>
            <span class="badge bg-primary" id="courseCount">{{ courses.total }}</span>
        </div>
    </div>
    <div class="card-body p-0">
        {% if courses.items %}
        <div class="table-scroll-container">
            <table class="table premium-table mb-0">
                <thead>
                    <tr>
                        <th style="width: 20%;">Course Code</th>
                        <th style="width: 50%;">Course Name</th>
                        <th style="width: 30%; text-align: center;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for course in courses.items %}
                    <tr>
                        <td>
                            <span class="course-code-badge">{{ course.course_code }}</span>
                        </td>
                        <td>
                            <strong>{{ course.course_name }}</strong>
                        </td>
                        <td style="text-align: center;">
                            <button class="btn-delete-course" data-bs-toggle="modal" data-bs-target="#deleteCourseModal-{{ course.id }}">
                                <i class="fas fa-trash me-1"></i>Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <p><strong>No courses found</strong></p>
            <p class="text-muted">Click "Add New Course" to create your first course</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Pagination -->
{% if courses.pages > 1 %}
<nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center">
        {% if courses.has_prev %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('admin.manage_courses', page=courses.prev_num) }}">
                <i class="fas fa-chevron-left"></i>
            </a>
        </li>
        {% endif %}
        
        {% for page_num in courses.iter_pages() %}
            {% if page_num %}
                {% if page_num == courses.page %}
                <li class="page-item active">
                    <span class="page-link">{{ page_num }}</span>
                </li>
                {% else %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('admin.manage_courses', page=page_num) }}">{{ page_num }}</a>
                </li>
                {% endif %}
            {% endif %}
        {% endfor %}
        
        {% if courses.has_next %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('admin.manage_courses', page=courses.next_num) }}">
                <i class="fas fa-chevron-right"></i>
            </a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}
{% endblock %}

{% block modals %}
<!-- Add Course Modal -->
<div class="modal fade" id="addCourseModal" tabindex="-1" aria-labelledby="addCourseModalLabel" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="addCourseForm" method="POST" action="{{ url_for('admin.manage_courses') }}">
                <div class="modal-header" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white;">
                    <h5 class="modal-title"><i class="fas fa-book me-2"></i>Add New Course</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="padding: 2rem;">
                    <input type="hidden" name="action" value="add">
                    <div class="mb-4">
                        <label for="course_code" class="form-label fw-bold">Course Code</label>
                        <input type="text" class="form-control form-control-lg" id="course_code" name="course_code" required 
                               placeholder="e.g., CS101" autofocus>
                        <div class="form-text">Enter a unique course code (e.g., CS101, MATH201)</div>
                    </div>
                    <div class="mb-4">
                        <label for="course_name" class="form-label fw-bold">Course Name</label>
                        <input type="text" class="form-control form-control-lg" id="course_name" name="course_name" required
                               placeholder="e.g., Introduction to Computer Science">
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #e5e7eb; padding: 1.5rem;">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> Cancel
                    </button>
                    <button type="submit" class="btn-modern btn-modern-primary">
                        <i class="fas fa-plus me-2"></i>Add Course
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Course Modals -->
{% for course in courses.items %}
<div class="modal fade" id="deleteCourseModal-{{ course.id }}" tabindex="-1" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Course</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the course "{{ course.course_name }}"?</p>
            </div>
            <div class="modal-footer">
                <form method="POST" action="{{ url_for('admin.manage_courses') }}">
                    <input type="hidden" name="action" value="delete">
                    <input type="hidden" name="course_id" value="{{ course.id }}">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Toast for success/error messages -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1090">
    <div id="toastMessage" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
        <div class="toast-header bg-success text-white">
            <strong class="me-auto">Success</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            Operation completed successfully.
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// ==================== DEBUGGING & SAFE INITIALIZATION ====================
console.log('========== MANAGE COURSES DEBUG ==========');
console.log('Bootstrap available:', typeof bootstrap !== 'undefined');
console.log('Bootstrap Modal class:', typeof bootstrap?.Modal !== 'undefined');
console.log('Bootstrap version:', bootstrap?.Modal?.VERSION || 'Unknown');

// Check for duplicate Bootstrap loads
const bootstrapScripts = document.querySelectorAll('script[src*="bootstrap"]');
console.log('Bootstrap scripts found:', bootstrapScripts.length);
bootstrapScripts.forEach((script, i) => {
    console.log(`  Script ${i}:`, script.src);
});

// Safe Bootstrap Component Initialization
function safeInitializeBootstrapComponents() {
    console.log('Safely initializing Bootstrap components...');
    
    // Check if Bootstrap is available
    if (typeof bootstrap === 'undefined') {
        console.error('Bootstrap is not loaded!');
        return;
    }
    
    // SAFE TOOLTIP INITIALIZATION (if needed)
    if (typeof bootstrap.Tooltip !== 'undefined') {
        const tooltipElements = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltipElements.forEach(element => {
            try {
                // Use getOrCreateInstance which is safer than new
                bootstrap.Tooltip.getOrCreateInstance(element);
            } catch (e) {
                console.warn('Could not initialize tooltip:', e);
            }
        });
    }
    
    // SAFE TOAST INITIALIZATION (if needed)
    if (typeof bootstrap.Toast !== 'undefined') {
        const toastElements = document.querySelectorAll('.toast');
        toastElements.forEach(element => {
            try {
                // Use getOrCreateInstance which is safer than new
                bootstrap.Toast.getOrCreateInstance(element);
            } catch (e) {
                console.warn('Could not initialize toast:', e);
            }
        });
    }
    
    // IMPORTANT: DO NOT INITIALIZE MODALS - Bootstrap auto-initializes them via data attributes
    console.log('Modals are auto-initialized by Bootstrap via data-bs-toggle attributes');
    
    // Verify modals exist
    const modals = document.querySelectorAll('.modal');
    console.log('Modal elements found:', modals.length);
    
    // Check modal triggers
    const modalTriggers = document.querySelectorAll('[data-bs-toggle="modal"]');
    console.log('Modal triggers found:', modalTriggers.length);
}

// ==================== FORM HANDLING ====================
function setupFormHandlers() {
    console.log('Setting up form handlers...');
    
    // Handle add course form submission
    const addCourseForm = document.getElementById('addCourseForm');
    
    if (addCourseForm) {
        console.log('Add Course Form found');
        
        addCourseForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('Add Course Form submitted');
            
            const submitButton = this.querySelector('button[type="submit"]');
            const originalButtonText = submitButton?.innerHTML;
            
            try {
                // Show loading state
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
                }
                
                const formData = new FormData(this);
                const response = await fetch(this.getAttribute('action'), {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    }
                });
                
                const data = await response.json();
                console.log('Server response:', data);
                
                if (data.success) {
                    // Show success message
                    showToast(data.message || 'Operation completed successfully!', 'success');
                    
                    // Close modal safely
                    const modalElement = document.getElementById('addCourseModal');
                    if (modalElement) {
                        // Try to get existing modal instance
                        if (typeof bootstrap !== 'undefined' && typeof bootstrap.Modal !== 'undefined') {
                            const modalInstance = bootstrap.Modal.getInstance(modalElement);
                            if (modalInstance) {
                                modalInstance.hide();
                            } else {
                                // Fallback: click close button
                                const closeBtn = modalElement.querySelector('[data-bs-dismiss="modal"]');
                                if (closeBtn) closeBtn.click();
                            }
                        } else {
                            // Fallback: click close button
                            const closeBtn = modalElement.querySelector('[data-bs-dismiss="modal"]');
                            if (closeBtn) closeBtn.click();
                        }
                    }
                    
                    // Reload the page after a short delay
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    throw new Error(data.message || 'An error occurred');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast(error.message || 'An error occurred. Please try again.', 'error');
            } finally {
                // Reset button state
                if (submitButton) {
                    submitButton.disabled = false;
                    if (originalButtonText) {
                        submitButton.innerHTML = originalButtonText;
                    }
                }
            }
        });
    } else {
        console.log('Add Course Form not found');
    }
    
    // Handle delete forms - prevent double confirmation
    document.querySelectorAll('form[action*="manage_courses"]').forEach(form => {
        const hiddenAction = form.querySelector('input[name="action"][value="delete"]');
        if (hiddenAction) {
            // Only add listener once
            if (!form.dataset.deleteHandlerAdded) {
                form.dataset.deleteHandlerAdded = 'true';
                form.addEventListener('submit', function(e) {
                    if (!confirm('Are you sure you want to delete this course?')) {
                        e.preventDefault();
                    }
                });
            }
        }
    });
}

//

// Helper function to show toast messages
function showToast(message, type = 'info') {
    console.log('Showing toast:', type, message);
    const toastEl = document.getElementById('toastMessage');
    if (!toastEl) {
        console.log('Toast element not found');
        return;
    }
    
    // Update toast content
    const toastBody = toastEl.querySelector('.toast-body');
    const toastHeader = toastEl.querySelector('.toast-header');
    
    if (toastBody) {
        toastBody.textContent = message;
    }
    
    if (toastHeader) {
        // Update toast header based on type
        const typeClasses = {
            'success': 'bg-success text-white',
            'error': 'bg-danger text-white',
            'warning': 'bg-warning text-dark',
            'info': 'bg-info text-white'
        };
        
        toastHeader.className = `toast-header ${typeClasses[type] || 'bg-primary text-white'}`;
        const strong = toastHeader.querySelector('strong');
        if (strong) {
            strong.textContent = type.charAt(0).toUpperCase() + type.slice(1);
        }
    }
    
    // Show toast using Bootstrap if available
    if (typeof bootstrap !== 'undefined' && typeof bootstrap.Toast !== 'undefined') {
        try {
            const toast = bootstrap.Toast.getOrCreateInstance(toastEl);
            toast.show();
        } catch (e) {
            console.warn('Could not show toast via Bootstrap:', e);
            // Fallback: show manually
            toastEl.classList.add('show');
            setTimeout(() => toastEl.classList.remove('show'), 5000);
        }
    } else {
        // Fallback: show manually
        toastEl.classList.add('show');
        setTimeout(() => toastEl.classList.remove('show'), 5000);
    }
}

// ==================== MAIN INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM fully loaded, initializing...');
    
    // Initialize Bootstrap components safely
    safeInitializeBootstrapComponents();
    
    // Setup form handlers
    setupFormHandlers();
    
    // Setup pagination handlers
    setupPaginationHandlers();
    
    // Add debug button
    const debugBtn = document.createElement('button');
    debugBtn.className = 'btn btn-warning btn-sm position-fixed bottom-0 start-0 m-3';
    debugBtn.textContent = 'Debug';
    debugBtn.style.zIndex = '9999';
    debugBtn.onclick = function() {
        console.log('=== COURSES DEBUG INFO ===');
        console.log('Bootstrap:', typeof bootstrap !== 'undefined' ? 'Loaded' : 'NOT LOADED');
        console.log('Modal triggers:', document.querySelectorAll('[data-bs-toggle="modal"]').length);
        console.log('Modals:', document.querySelectorAll('.modal').length);
        console.log('Pagination links:', document.querySelectorAll('.pagination a.page-link').length);
        
        // Test modal functionality
        const testTrigger = document.querySelector('[data-bs-toggle="modal"]');
        if (testTrigger) {
            console.log('First modal trigger:', testTrigger.getAttribute('data-bs-target'));
        }
    };
    document.body.appendChild(debugBtn);
});
</script>
{% endblock %}
